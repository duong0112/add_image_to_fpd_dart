<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Web2 Container</title>

    <style>
        body {
          font-family: Arial, sans-serif;
          margin: 16px;
        }
        #iframeContainer {
          margin-top: 16px;
          width: 100%;
          height: 80vh;
          border: none;
        }
        #status {
          margin-top: 10px;
          font-weight: bold;
        }
    </style>
</head>

<body>

<h2>Web2 Container</h2>

<button id="sendButton">G·ª≠i PDF (ArrayBuffer) sang Web1</button>
<div id="status">Ch∆∞a c√≥ d·ªØ li·ªáu</div>

<iframe
        id="iframeContainer"
        src="http://10.1.27.129:10841/#/add-image-to-file">
</iframe>

<script>
    const iframe = document.getElementById("iframeContainer");
    const statusDiv = document.getElementById("status");
    const sendButton = document.getElementById("sendButton");

    /* =========================================================
     * FIX 1: L·∫Øng nghe message t·ª´ Web1 (Flutter Web)
     * ========================================================= */
    window.addEventListener("message", (event) => {
      if (event.origin === "http://10.1.27.129:10841") {
        console.log("[Web2] Receive from Web1:", event.data);
        statusDiv.textContent = "Nh·∫≠n ph·∫£n h·ªìi t·ª´ Web1";
      }
    });

    /* =========================================================
     * FIX 2: G·ª≠i PDF b·∫±ng ArrayBuffer (KH√îNG Base64)
     * ========================================================= */
    sendButton.addEventListener("click", async () => {
      try {
        statusDiv.textContent = "ƒêang load PDF...";

        /* -----------------------------------------------------
         * FIX 2.1: Load PDF (c√≥ th·ªÉ thay b·∫±ng fetch API th·∫≠t)
         * ----------------------------------------------------- */
        const pdfUrl = "/sample.pdf"; // üëâ thay b·∫±ng PDF th·∫≠t
        const response = await fetch(pdfUrl);
        const pdfArrayBuffer = await response.arrayBuffer();

        console.log("[Web2] PDF loaded, bytes =", pdfArrayBuffer.byteLength);

        /* -----------------------------------------------------
         * FIX 2.2: T·∫°o message object (KH√îNG stringify)
         * ----------------------------------------------------- */
        const message = {
          type: "INIT_PDF",                // Flutter d√πng key n√†y ƒë·ªÉ ph√¢n bi·ªát
          employeeIds: [41044827],
          pdfBuffer: pdfArrayBuffer,       // üî• ArrayBuffer
          lstSignImageLocationDto: []
        };

        /* -----------------------------------------------------
         * FIX 2.3: postMessage + Transfer ownership
         * ----------------------------------------------------- */
        iframe.contentWindow.postMessage(
          message,
          "http://10.1.27.129:10841",
          [pdfArrayBuffer] // üî• R·∫§T QUAN TR·ªåNG: transfer ownership
        );

        statusDiv.textContent = "ƒê√£ g·ª≠i PDF (ArrayBuffer) sang Web1";
        console.log("[Web2] postMessage success");

      } catch (err) {
        console.error("[Web2] Error:", err);
        statusDiv.textContent = "L·ªói khi g·ª≠i PDF";
      }
    });
</script>

</body>
</html>
